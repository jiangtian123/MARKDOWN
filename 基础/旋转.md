# 旋转

## 一.定向

三维方向的定义为**定向**。如何理解定向还需了解以下术语：

- 方向

- 角位移

  视为一个运算符，接受一个输入并且产生一个输出。例子”围绕Z轴旋转90°“

- 旋转

方向是一个矢量，更类似于描述一个物体在原点的哪个方向。

举个例子就是：在一个场景中，一个人站在原点的东南方向看向西北方向（没有办法描述绝对的位置和定向）。在上句话中，人相对原点是东南方向，而人的朝向就是定向。
由于没办法办法直接描述定向，所以我们可以像通过平移描述位置一样，我们可以通过一些已知的参考方向的旋转给出定向。

旋转量称为角位移。换句话说，描述定向在数学上等于描述角位移。

定向和角位移的区别类似于点和矢量的区别。

## 矩阵形式

描述三维中坐标空间的定向的一种方法是告诉该坐标空间（+x,+y,+z）的基矢量指向哪个方向。

当基矢量构成3X3矩阵的行时，就是用矩阵形式表示了定向。另一句话说，可以通过给出一个旋转矩阵来表示两个坐标空间的相对定向。旋转矩阵可以用于将矢量从一个坐标空间变换到另一个坐标空间。

![](https://pic4.zhimg.com/80/v2-f6b4ef965d3f5af6ef930da5327a101b_1440w.webp)

直立空间的轴的朝向与世界空间一致，但是原点与物体空间重合。

与View矩阵有点类似。

### 方向余弦矩阵

方向余弦矩阵与旋转矩阵相同，只是一个解释矩阵的特殊方式。

旋转矩阵中的每个元素等于一个空间这种的基本轴与另一个空间中的基本轴的点积。例如3X3矩阵中的中心元素$m_{22}$给出了一个空间中的Y轴和另一个空间中的Y轴形成的点积。

例：坐标空间的基矢量是相互正交的单位矢量**p,q,r**而具有相同原点的的第二个坐标空间的基矢量是不同的基矢量$p^`,q^`,r^`$,将矢量从第一个空间旋转到第二个空间的旋转矩阵可以用每对基矢量之间的角度的余弦构造，当然两个单位矢量的点积正好等于他们之间的余弦。所以矩阵乘积是：

$\begin{matrix} p*p^`&q*p^`&r*p^` \\ p*q^`&q*q^`&r*q^` \\ p*r^`&q*r^`&r*r^`\end{matrix}$ 

### 例子

若一架飞机，在起飞前，其坐标轴的基矢量与地面一样，当飞机起飞后，如何描述飞机当前的定向（姿态）呢？

我们只要获取某一时刻的飞机的三个轴相对地面坐标的方向，即可构建一个旋转矩阵，但是我们需要保存九个数据。一种节省空间的办法是欧拉角

## 欧拉角

欧拉角将角位移定义为围绕三个相互垂直的轴的三个旋转的序列。

任何顺序任何三个轴都可以工作，但是我们遵守一些常见约定。下面采用”航向(head)（y）—俯仰（pich）（X）—滚转（roll）（Z）“约定。在进行旋转时，另外两个轴也会跟着旋转（与固定轴不同，固定轴旋转时基矢量不变）。

### 直立旋转和物体空间旋转

- 直立空间旋转即绕固定轴旋转，在旋转过程中，三个基矢量的世界坐标始终不变。
- 物体空间旋转即在旋转中，三个基矢量会发生变化。

对于这两种旋转，有一个规律：如果开始旋转时物体空间与直立空间重合，那么交换两种旋转的次序可实现同样的旋转变换。

简单起见，我把直立空间三根轴称之为 xyz，同时物体空间称之为 phr，与 xyz 一一对应。举个例子，一个物体的初始位置和定向与直立空间重合，绕体轴旋转：一个物体先绕自身的 x 轴（实际是 p 轴）正向旋转 90，再绕自身的 y 轴（实际是 h 轴）正向旋转 45. 再考察绕固定轴旋转：先绕直立空间的 y 轴正向旋转 45，再绕直立空间的 x 轴正向旋转 90. 可以得到一样的结果，如图所示：

<img src="https://pic1.zhimg.com/80/v2-4e352e7fb98cb1bb399362d2f2c60c48_1440w.webp" style="zoom:50%;" />

绕直立空间的旋转矩阵可以表述为：

$R_x(\theta) = 
\left[ \begin{matrix} 1&0&0&0  \\0&\cos\theta&-sin\theta&0 \\0&sin\theta&cos\theta&0\\0&0&0&1 \end{matrix}\right]  R_y(\theta) = \left[\begin{matrix} cos\theta&0&sin\theta&0  \\0&1&0&0 \\-sin\theta&0&cos\theta& 0\\0&0&0&1 \end{matrix}\right] R_z(\theta) = \left[\begin{matrix} cos\theta&-sin\theta&0&0  \\sin\theta&con\theta&0&0 \\0&0&1&0\\0&0&0&1 \end{matrix}\right] \tag{1}
$ 



而绕体轴旋转的矩阵，因为每一次变换都会对下一次的轴造成影响，所以更相当于是：绕任意轴旋转的矩阵。

$$ X = M^TR_X(\theta)M $$

<img src="https://pic2.zhimg.com/80/v2-4d4e905de4658bfbca782be5ce10e025_1440w.webp" style="zoom:50%;" />

所以，在将欧拉角转换为矩阵时，一定要区分是绕固定轴旋转，还是绕体轴旋转。

绕固定轴旋转：可以根据绕坐标轴的旋转矩阵写出。如先绕 y 轴旋转 h 角度，再绕 x 轴旋转 p 角度，最后绕 z 轴旋转 r 角度，可以写出矩阵表达式：

![](https://pic4.zhimg.com/v2-ec0902bb1216c0b967ac9dd1c102374b_r.jpg)

绕体轴旋转：则需要跟踪物体坐标轴的定向，通过绕任意轴的旋转矩阵写出，比较繁琐。假如还是绕体轴 h 轴旋转 h 角度，再绕体轴 p 轴旋转 p 角度，最后绕体轴 r 轴旋转 r 角度，注意 phr 与 xyz 相对应，可写成：

![](https://pic3.zhimg.com/80/v2-2fd4b73b484b9735da41f46353c7ca4e_1440w.webp)

一个特殊的情况上面也说到过：当初始状态物体空间与直立空间重合，即初始定向为单位矩阵时，交换直立空间的旋转次序，也可得到物体空间的旋转矩阵，上图左边的式子可写为：

![](https://pic4.zhimg.com/80/v2-d2ceec0003bc103e6c048b44619f7edb_1440w.webp)

### 欧拉角会带来一些问题

1. 别名问题

   想象一下转头90°和转头90°+360°会得到一样的结果，所以常常限制欧拉角的范围 Head,Roll为[-180，180]，Pitch为[-90，90]。

2. 其次是不同的旋转次序可能得到一样的结果。

3. 万向死锁

   ![](https://pic4.zhimg.com/80/v2-58944ed7d530fea15ac4cfc3d390abbf_1440w.webp)

   网上经常可以看到这样一个图，用来描述机械学中的万向死锁现象，但这种模型不存在于图形学中。

   在第一次旋转绿色的 y，这时候里面的红色 x 和蓝色 z 是跟着转的，确实符合绕体轴旋转（也叫物体空间旋转、动态旋转）的规律，但是第二次旋转红色的 x，此时绿色的 y 已经没转了，只有蓝色的 z 在和 x 一起转，然后第三次旋转蓝色的 z，此时也没有带动绿色的 y 和红色的 x 一起旋转。

   所以后面两次旋转不符合绕体轴旋转的规律，所以才会出现上右图这种两根轴重合的情况，而在图形学中，不管是绕固定轴旋转还是绕体轴旋转（即有人称之动态和静态两种旋转），都是不可能让坐标轴重合的，所以始终不会“锁住”。

   所以我很赞同 Niklas Frykholm 在他的博客里面将 Gimbal Lock（万向节死锁）称之为 Euler angle flip（欧拉角翻转） 或者 coordinate singularity（坐标奇异性），我将图形学里面的“万向节死锁”带来的影响分为两点：

   - 旋转冗余。在绕体轴旋转的时候，如果第二次旋转的角度为90°，就会导致第三次旋转轴与第一次旋转轴重合，产生旋转冗余。如下图：

     ![](https://pic4.zhimg.com/80/v2-333c5a72041521ac35e6ed1f72d2e467_1440w.webp)

     第二次旋转90°后，再旋转Z轴，就相当于旋转第一次的X轴。完全可以在第一次就旋转完成。

     但是这种问题无法规避，可以用四元数来记录旋转操作。

   - 第二个就是插值问题。我觉得更像是欧拉角显而易见的别名问题带来的，而不是万向节死锁。由于欧拉角的别名问题，在限制范围之前，如将 0 度和 360 度插值，是选择从 0~360 旋转一圈，还是不插值？如果限制了范围，即制定了“规范欧拉角”的规则，在插值时还是会有问题，比如从 -170 度插值到 170，是选择 340 度的范围还是选择 20 度的范围？

## 四元数

